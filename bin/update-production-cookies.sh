#!/bin/bash
# Script tự động tạo cookies mới cho YouTube trên môi trường production
# Tác giả: Khang
# Ngày: 2/7/2025

echo "=== Cập nhật cookies YouTube cho môi trường production ==="

# Kiểm tra thư mục
BACKEND_DIR="$(pwd)/backend"
if [ ! -d "$BACKEND_DIR" ]; then
  BACKEND_DIR="$(pwd)"
fi

COOKIES_FILE="$BACKEND_DIR/cookies.txt"
echo "Thư mục backend: $BACKEND_DIR"
echo "File cookies: $COOKIES_FILE"

# Cài đặt yt-dlp nếu chưa có
if ! command -v yt-dlp &> /dev/null; then
  echo "Cài đặt yt-dlp..."
  pip install -U "yt-dlp[web]"
fi

# Tạo cookies giả mới
echo "Tạo cookies mới cho YouTube..."

cat > "$COOKIES_FILE" << EOL
# Netscape HTTP Cookie File
# This file is generated by yt-dlp for use with cookies.txt format
# It contains both domain and path, and should works with curl and wget

.youtube.com	TRUE	/	TRUE	2147483647	CONSENT	PENDING+$(date +%s)
.youtube.com	TRUE	/	TRUE	2147483647	PREF	f6=40000000&f4=4000000&tz=Asia.Saigon
.youtube.com	TRUE	/	TRUE	2147483647	VISITOR_INFO1_LIVE	$(openssl rand -hex 16)
.youtube.com	TRUE	/	TRUE	2147483647	YSC	$(openssl rand -hex 10)
.youtube.com	TRUE	/	FALSE	2147483647	GPS	1
EOL

echo "Cookies mới đã được tạo."

# Cấu hình yt-dlp trên production
echo "Cấu hình lại yt-dlp để hoạt động tốt hơn trên production..."

# Tạo file cấu hình
mkdir -p "$BACKEND_DIR/config"
CONFIG_FILE="$BACKEND_DIR/config/yt-dlp.conf"

cat > "$CONFIG_FILE" << EOL
# Cấu hình yt-dlp
--extractor-args "youtube:player_client=android,web,tv"
--extractor-args "youtube:api=innertube"
--no-check-certificates
--user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
--add-header "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
--add-header "Accept-Language: en-US,en;q=0.9"
--add-header "Sec-Fetch-Mode: navigate"
--add-header "Sec-Fetch-Dest: document"
--add-header "Sec-Fetch-Site: none"
--cookies "$COOKIES_FILE"
--no-part
--quiet
EOL

echo "Đã tạo file cấu hình yt-dlp tại: $CONFIG_FILE"

# Kiểm tra cấu hình
echo "Thử nghiệm cấu hình mới..."
TEST_VIDEO="dQw4w9WgXcQ"

if yt-dlp --config-location "$CONFIG_FILE" -j --skip-download "https://www.youtube.com/watch?v=$TEST_VIDEO" &> /dev/null; then
  echo "THÀNH CÔNG! Cấu hình hoạt động tốt."
else
  echo "Thử phương pháp thay thế..."
  if yt-dlp --config-location "$CONFIG_FILE" -j --skip-download "https://www.youtube.com/embed/$TEST_VIDEO" &> /dev/null; then
    echo "THÀNH CÔNG! URL embed hoạt động tốt."
    echo "embed_url=true" >> "$CONFIG_FILE"
  else
    echo "Cảnh báo: Không thể trực tiếp lấy dữ liệu từ YouTube."
    echo "Sẽ sử dụng dịch vụ Invidious và Piped để thay thế."
    echo "fallback_only=true" >> "$CONFIG_FILE"
  fi
fi

echo "=== Hoàn tất cập nhật cookies và cấu hình ==="
echo "Bạn có thể chạy script này định kỳ để cập nhật cookies và tránh bị YouTube chặn."
echo "Đề xuất: Thêm vào cronjob chạy mỗi 24 giờ."

# Hướng dẫn cronjob
echo ""
echo "=== Hướng dẫn thêm cronjob ==="
echo "Chạy lệnh: crontab -e"
echo "Thêm dòng sau:"
echo "0 */12 * * * cd $(pwd) && ./bin/update-production-cookies.sh >> /var/log/yt-cookies-update.log 2>&1"
echo ""
echo "Cronjob này sẽ chạy script cập nhật mỗi 12 giờ." 