#!/bin/bash
# Script cập nhật môi trường Render.com
# Chạy script này khi deploy trên Render.com
# Script sẽ tạo các thư mục cần thiết và cấu hình yt-dlp

echo "=== Cập nhật môi trường Render.com ==="

# Đảm bảo thư mục bin tồn tại
mkdir -p bin

# Kiểm tra và tải yt-dlp nếu cần
if [ ! -f "bin/yt-dlp" ]; then
  echo "Tải yt-dlp..."
  curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o bin/yt-dlp
  chmod +x bin/yt-dlp
  echo "Đã tải yt-dlp phiên bản mới nhất"
fi

# Đảm bảo thư mục cấu hình tồn tại
mkdir -p backend/config

# Tạo file cookies.txt với dữ liệu giả
echo "Tạo cookies giả cho YouTube..."
cat > backend/cookies.txt << EOL
# Netscape HTTP Cookie File
# This file is generated by yt-dlp for use with cookies.txt format
# It contains both domain and path, and should works with curl and wget

.youtube.com	TRUE	/	TRUE	2147483647	CONSENT	PENDING+$(date +%s)
.youtube.com	TRUE	/	TRUE	2147483647	PREF	f6=40000000&f4=4000000&tz=Asia.Saigon
.youtube.com	TRUE	/	TRUE	2147483647	VISITOR_INFO1_LIVE	$(head -c 16 /dev/urandom | hexdump -v -e '/1 "%02x"')
.youtube.com	TRUE	/	TRUE	2147483647	YSC	$(head -c 10 /dev/urandom | hexdump -v -e '/1 "%02x"')
.youtube.com	TRUE	/	FALSE	2147483647	GPS	1
EOL

# Tạo file cấu hình yt-dlp
echo "Tạo file cấu hình yt-dlp..."
cat > backend/config/yt-dlp.conf << EOL
# Cấu hình yt-dlp
--extractor-args "youtube:player_client=android,web,tv"
--extractor-args "youtube:api=innertube"
--no-check-certificates
--user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
--add-header "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
--add-header "Accept-Language: en-US,en;q=0.9"
--add-header "Sec-Fetch-Mode: navigate"
--add-header "Sec-Fetch-Dest: document"
--add-header "Sec-Fetch-Site: none"
--cookies "$(pwd)/backend/cookies.txt"
--no-part
--quiet
EOL

# Thêm cài đặt fallback_only=true cho an toàn
echo "fallback_only=true" >> backend/config/yt-dlp.conf
echo "embed_url=true" >> backend/config/yt-dlp.conf

# Tạo thư mục cache
mkdir -p cache

# Cập nhật package.json để thêm các script mới
if [ -f "package.json" ]; then
  echo "Cập nhật package.json..."
  
  # Kiểm tra nếu script update-cookies đã tồn tại
  if ! grep -q "update-cookies" package.json; then
    # Thêm script update-cookies
    sed -i 's/"scripts": {/"scripts": {\n    "update-cookies": "bin\/update-production-cookies.sh",/g' package.json
  fi
  
  echo "Đã cập nhật package.json"
fi

echo "=== Hoàn tất cập nhật môi trường Render.com ==="
echo "Môi trường đã được cấu hình để hoạt động tốt với YouTube Music Web trên Render.com" 